<!DOCTYPE html>
<html lang="en">
	<head>
		<link rel="shortcut icon" href="#" />
		<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
		<link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
		<script src="https://kit.fontawesome.com/08f2822b68.js" crossorigin="anonymous"></script>
		<title>admin/users</title>
		<!-- <link
			rel="stylesheet"
			href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/css/bootstrap.min.css"
			integrity="sha384-DhY6onE6f3zzKbjUPRc2hOzGAdEf4/Dz+WJwBvEYL/lkkIsI3ihufq9hk9K4lVoK"
			crossorigin="anonymous"
		/> -->
		<!-- <script
			src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.bundle.min.js"
			integrity="sha384-BOsAfwzjNJHrJ8cZidOg56tcQWfp6y72vEJ8xQ9w6Quywb24iOsW913URv1IS4GD"
			crossorigin="anonymous"
			></script> -->
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.min.css" />
		<link
			rel="stylesheet"
			type="text/css"
			href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" />
		<link
			rel="stylesheet"
			type="text/css"
			href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap5.min.css" />

		<link rel="stylesheet" href="../stylesheets/styleB.css" />
	</head>
	<body>
		<div class="container-a">
			<header class="header">
				<nav class="menu">
					<a href="#" class="toggle-btn">
						<i class="fas fa-bars icon"></i>
					</a>
					<div class="navbar-link">
						<ul>
							<li><a href="../index.html">Home</a></li>
							<li><a href="./usersA.html">Users</a></li>
							<li><a href="./photosA.html">Photos</a></li>
							<li><a href="./categoriesA.html">Categories</a></li>
							<li><a href="./captionsA.html">Captions</a></li>
							<li><a href="./votesA.html">Votes</a></li>
							<li><a href="./inscriptionsA.html">Inscriptions</a></li>
						</ul>
					</div>
				</nav>
				<div class="title">
					<h1>PHOTO CAPTION CONTEST</h1>
					<h3>INTERNATIONAL MONOCHROME CONTEST</h3>
				</div>
				<div class="user">
					<!-- <a href="#" id="login" ">Login</a>
        <p>|</p>
        <a href="#" id="register">Join</a> -->
					<p></p>
				</div>
			</header>
			<div class="container-fluid">
				<button id="btnCrear" class="btn btn-dark mt-2">Crear</button>
				<div class="row shadow-lg p-3 mb-5">
					<div class="col">
						<table
							id="tablaArticulos"
							class="table table-striped table-bordered"
							style="width: 100%">
							<thead>
								<tr>
									<th>ID</th>
									<th>First Name</th>
									<th>Last Name</th>
									<th>Email</th>
									<th>Phone</th>
									<th>Address</th>
									<th>Address 2</th>
									<th>City</th>
									<th>State</th>
									<th>Zip</th>
									<th>Country</th>
									<th>Role</th>
									<!-- <th>url</th> -->
									<th class="text-center">ACCIONES</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
				<!-- </div> -->

				<!--Modal para CRUD-->
				<div
					id="modalCRUD"
					class="modal fade"
					tabindex="-1"
					role="dialog"
					aria-labelledby="exampleModalLabel"
					aria-hidden="true">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="exampleModalLabel"></h5>
							</div>
							<form id="formArticulos">
								<div class="modal-body">
									<input id="id" hidden />
									<label for="" class="col-form-label">FirstName</label>
									<input type="text" class="form-control" id="first_name" />
									<label for="" class="col-form-label">LastName</label>
									<input type="text" class="form-control" id="last_name" />
									<label for="" class="col-form-label">Email</label>
									<input type="text" class="form-control" id="email" />
									<label for="" class="col-form-label">Phone</label>
									<input type="text" class="form-control" id="phone" />
									<label for="" class="col-form-label">Address</label>
									<input type="text" class="form-control" id="address" />
									<label for="" class="col-form-label">Address 2</label>
									<input type="text" class="form-control" id="address2" />
									<label for="" class="col-form-label">City</label>
									<input type="text" class="form-control" id="city" />
									<label for="" class="col-form-label">State</label>
									<input type="text" class="form-control" id="state" />
									<label for="" class="col-form-label">Zip</label>
									<input type="text" class="form-control" id="zip" />
									<label for="" class="col-form-label">Country</label>
									<input type="text" class="form-control" id="country" />
									<label for="" class="col-form-label">Role</label>
									<input type="text" class="form-control" id="role" />
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">
										Cancelar
									</button>
									<button type="submit" id="btnGuardar" class="btn btn-dark">Guardar</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>

			<script
				type="text/javascript"
				language="javascript"
				src="https://code.jquery.com/jquery-3.5.1.js"></script>
			<script
				src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
				integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
				crossorigin="anonymous"></script>
			<script
				src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.min.js"
				integrity="sha384-5h4UG+6GOuV9qXh6HqOLwZMY4mnLPraeTrjT5v07o347pj6IkfuoASuGBhfDsp3d"
				crossorigin="anonymous"></script>
			<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.all.min.js"></script>
			<script
				type="text/javascript"
				language="javascript"
				src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
			<script
				type="text/javascript"
				language="javascript"
				src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap5.min.js"></script>
			<script>
				$(document).ready(function () {
					let token = localStorage.getItem('tkn')
					let tkn = `Bearer ${localStorage.getItem('tkn')}`.replaceAll('"', '')

					if (!token) {
						window.location.href = '../index.html'
					}

					let url = 'http://localhost:3000/users'
					let opcion = null
					let id,
						first_name,
						last_name,
						email,
						phone,
						address,
						address2,
						city,
						state,
						zip,
						country,
						role
					//MOSTRAR
					let tablaArticulos = $('#tablaArticulos').DataTable({
						ajax: {
							url: url,
							method: 'GET',
							headers: {
								'Content-Type': 'application/json',
								Authorization: tkn
							},
							dataSrc: ''
						},
						columns: [
							{ data: 'id' },
							{ data: 'first_name' },
							{ data: 'last_name' },
							{ data: 'email' },
							{ data: 'phone' },
							{ data: 'address' },
							{ data: 'address2' },
							{ data: 'city' },
							{ data: 'state' },
							{ data: 'zip_code' },
							{ data: 'country' },
							{ data: 'role' },
							{
								defaultContent:
									'<div class="text-center"><div class="btn-group"><button class="btn btn-dark btn-sm btnEditar">Editar</button><button class="btn btn-dark btn-sm btnBorrar">Borrar</button></div></div>'
							}
						],
						columnDefs: [
							{
								targets: [4]
								// render(v) {
								// return Number(v).toFixed(0);
								// }
							}
						]
					})
					//CREAR
					$('#btnCrear').click(function () {
						opcion = 'crear'
						id = null
						$('#formArticulos').trigger('reset')
						$('.modal-header').css('background-color', '#23272b')
						$('.modal-header').css('color', 'white')
						$('.modal-title').text('Crear Artículo')
						$('#modalCRUD').modal('show')
					})
					//EDITAR
					$(document).on('click', '.btnEditar', function () {
						opcion = 'editar'
						fila = $(this).closest('tr')
						id = parseInt(fila.find('td:eq(0)').text())
						first_name = fila.find('td:eq(1)').text()
						last_name = fila.find('td:eq(2)').text()
						phone = fila.find('td:eq(3)').text()
						email = fila.find('td:eq(4)').text()
						address = fila.find('td:eq(5)').text()
						address2 = fila.find('td:eq(6)').text()
						city = fila.find('td:eq(5)').text()
						state = fila.find('td:eq(6)').text()
						zip = fila.find('td:eq(7').text()
						country = fila.find('td:eq(8)').text()
						role = fila.find('td:eq(11)').text()

						$('#id').val(id)
						$('#first_name').val(first_name)
						$('#last_name').val(last_name)
						$('#email').val(email)
						$('#phone').val(phone)
						$('#address').val(address)
						$('#address2').val(address2)
						$('#city').val(city)
						$('#state').val(state)
						$('#zip').val(zip)
						$('#country').val(country)
						$('#role').val(role)

						$('.modal-header').css('background-color', '#7303c0')
						$('.modal-header').css('color', 'white')
						$('.modal-title').text('Editar Artículo')
						$('#modalCRUD').modal('show')
					})

					//BORRAR
					$(document).on('click', '.btnBorrar', function () {
						fila = $(this)
						id = parseInt($(this).closest('tr').find('td:eq(0)').text())
						Swal.fire({
							title: '¿Confirma eliminar el registro?',
							showCancelButton: true,
							confirmButtonText: `Confirmar`
						}).then(result => {
							if (result.isConfirmed) {
								fetch(url + '/' + id, {
									method: 'DELETE'
								})
									.then(response => response.json())
									.then(data => {
										tablaArticulos.row(fila.parents('tr')).remove().draw()
									})
									.catch(error => console.log(error))
								// $.ajax({
								// 	url: url + id,
								// 	method: 'delete',
								// 	data: { id: id },
								// 	success: function () {
								// 		tablaArticulos.row(fila.parents('tr')).remove().draw();
								// 	}
								// });
								Swal.fire('¡Registro Eliminado!', '', 'success')
							}
							// if (result.isConfirmed) {
							// 	$.ajax({
							// 		url: url + id,
							// 		method: 'delete',
							// 		data: { id: id },
							// 		success: function () {
							// 			tablaArticulos.row(fila.parents('tr')).remove().draw();
							// 		}
							// 	});
							// 	Swal.fire('¡Registro Eliminado!', '', 'success');
							// }
						})
					})

					//submit para el CREAR y EDITAR
					$('#formArticulos').submit(function (e) {
						e.preventDefault()
						id = $.trim($('#id').val())
						first_name = $.trim($('#first_name').val())
						last_name = $.trim($('#last_name').val())
						email = $.trim($('#email').val())
						phone = $.trim($('#phone').val())
						address = $.trim($('#address').val())
						address2 = $.trim($('#address2').val())
						city = $.trim($('#city').val())
						state = $.trim($('#state').val())
						zip = $.trim($('#zip').val())
						country = $.trim($('#country').val())
						role = $.trim($('#role').val())
						const data = {
							// id: id,
							first_name: first_name,
							last_name: last_name,
							email: email,
							phone: phone,
							address: address,
							address2: address2,
							city: city,
							state: state,
							zip: zip,
							country: country,
							role: role
						}

						if (opcion == 'crear') {
							fetch(url, {
								method: 'POST',
								body: JSON.stringify(data),
								headers: {
									'Content-Type': 'application/json'
								}
							})
								.then(response => response.json())
								.then(data => {
									id = data['id']
									first_name = data['first_name']
									last_name = data['last_name']
									email = data['email']
									phone = data['phone']
									address = data['address']
									address2 = data['address2']
									city = data['city']
									state = data['state']
									zip = data['zip']
									country = data['country']
									role = data['role']
									tablaArticulos.row
										.add({
											id: id,
											first_name: first_name,
											last_name: last_name,
											email: email,
											phone: phone,
											address: address,
											address2: address2,
											city: city,
											state: state,
											zip: zip,
											country: country,
											role: role
										})
										.draw()
								})
								.catch(error => console.log(error))
							// $.ajax({
							// 	url: url,
							// 	method: 'post',
							// 	contentType: 'application/json',
							// 	data: JSON.stringify(data),
							// 	success: function (data) {
							// 		tablaArticulos.ajax.reload(null, false);
							// 	}
							// });
						}
						if (opcion == 'editar') {
							console.log('EDITAR')

							fetch(url + '/' + id, {
								method: 'PUT',
								body: JSON.stringify(data),
								headers: {
									'Content-Type': 'application/json'
								}
							})
								.then(response => response.json())
								.then(console.log('Success:', JSON.stringify(data)))
								.then(data => {
									tablaArticulos.ajax.reload(null, false)
								})
								.catch(error => console.log(error))
						}
						$('#modalCRUD').modal('hide')
					})
				})
			</script>
			<script>
				let toggleButton = document.getElementsByClassName('toggle-btn')[0]
				let navbarLink = document.getElementsByClassName('navbar-link')[0]

				toggleButton.addEventListener('click', () => {
					navbarLink.classList.toggle('active')
				})
			</script>
		</div>
	</body>
</html>
